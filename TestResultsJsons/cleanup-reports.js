#!/usr/bin/env node
const fs=require("fs"),path=require("path"),reportsDir=__dirname;function getAllReports(){return fs.readdirSync(reportsDir).filter(e=>e.startsWith("gct-")&&e.endsWith(".json")).map(e=>{const t=path.join(reportsDir,e),n=fs.statSync(t);return{filename:e,path:t,size:n.size}})}function isEmptyReport(e){try{const t=fs.readFileSync(e,"utf8"),n=JSON.parse(t);if(!Array.isArray(n))return!0;if(0===n.length)return!0;let o=0,r=0;return n.forEach(e=>{e.elements&&Array.isArray(e.elements)&&(o+=e.elements.length,e.elements.forEach(e=>{e.steps&&Array.isArray(e.steps)&&(r+=e.steps.length)}))}),0===o||0===r}catch(t){return console.error(`Error reading ${e}:`,t.message),!0}}function findDuplicates(e){const t=new Map,n=[];return e.forEach(e=>{const o=e.filename.match(/gct-(\d{8})-(\d{6})\.json/);if(o){const r=`${o[1]}-${o[2]}`;if(t.has(r)){const o=t.get(r);e.size>o.size?(n.push(o),t.set(r,e)):n.push(e)}else t.set(r,e)}}),n}function cleanupReports(){console.log("\nðŸ§¹ Starting Report Cleanup...\n");const e=getAllReports();console.log(`ðŸ“Š Found ${e.length} total reports\n`),console.log("ðŸ” Checking for empty reports...");const t=e.filter(e=>isEmptyReport(e.path));console.log(`   Found ${t.length} empty reports\n`),console.log("ðŸ” Checking for duplicates...");const n=findDuplicates(e);console.log(`   Found ${n.length} duplicate reports\n`);const o=[...new Set([...t,...n])];if(0===o.length)return console.log("âœ… No reports to delete. Everything looks good!\n"),{deleted:0,remaining:e.length};console.log(`ðŸ—‘ï¸  Deleting ${o.length} reports:\n`);let r=0;return o.forEach(e=>{try{fs.unlinkSync(e.path),console.log(`   âœ… Deleted: ${e.filename}`),r++}catch(t){console.error(`   âŒ Failed to delete ${e.filename}:`,t.message)}}),console.log(`\n${"=".repeat(60)}`),console.log("ðŸ“Š Cleanup Summary:"),console.log(`   ðŸ—‘ï¸  Deleted: ${r} reports`),console.log(`   ðŸ“ Remaining: ${e.length-r} reports`),console.log(`${"=".repeat(60)}\n`),r>0&&(console.log("âœ¨ Done! Remember to regenerate the index:"),console.log("   node generate-index-enhanced.js\n")),{deleted:r,remaining:e.length-r}}require.main===module&&cleanupReports(),module.exports={cleanupReports,isEmptyReport,findDuplicates};